# GNN-DOL

* Here is the source code of paper **'Differentiable optimization layers enhance GNN-based mitosis detection'**.

* Our model called GNN-DOL enables mitosis detection by complementing a graph neural network(GNN) with a differentiable optimization layer (DOL) that implements the constraint.

* The data directory structure, dependence requirement and running example for training and prediction will be introduced here.

## Data description
You need to prepare the data files as the following structure:
```
├── data
│   ├── training-group-1
│   │   ├── sequence-1
│   │   │   ├──0001.tif
│   │   │   ├──0002.tif
│   │   │   ├──...
│   │   ├── sequence-2
│   │   ├── ...
│   ├── validation-group-1
│   │   ├── sequence-1
│   │   │   ├──0001.tif
│   │   │   ├──0002.tif
│   │   │   ├──...
│   │   ├── sequence-2
│   │   ├── ...
│   ├── prediction-group-1
│   │   ├── sequence-1
│   │   │   ├──0001.tif
│   │   │   ├──0002.tif
│   │   │   ├──...
│   │   ├── sequence-2
│   │   ├── ...
│   ├── ground_truth-group-1
│   │   ├── sequence-1.txt
│   │   ├── sequence-2.txt
│   │   ├── ...
│   ├── processed_data-group-1
│   │   ├── processed
│   │   ├── raw
│   │   ├── sequence-1_feature.csv
│   │   ├── g_structure.txt
```
Note that the directory 'processed_data-group-X' is one-to-one correspondence with the training data directory 'training-group-X', and all files in this directory is generated by 'graph_construct.py'. 

You need to prepare your own raw image files in TIFF format and ground-truth files in txt format. The content of ground-truth files is as follows:

| frame_id | cell_id| x_position | y_position | parent_id|current_frame_mark|
|  :----:  | :----:  |  :----:  | :----:  |  :----:  | :----:  |
  16 | 1 | 123 | 123 | -1 |-1|
  16 | 2 | 12  | 1300 | -1 |-1|  
  ... | ... | ...  | ... | ... |...|

The column 'current_frame_mark' is an -1 or 0 integer to indicate whether the corresponding frame is frame t or frame t+1. Here we use -1 to indicate frame t and use 0 to indicate frame frame t+1. 

## Requirements

To run the GNN-DOL, you need to install the following dependencies:

* torch-geometric 1.7.1
* cvxpy 1.1.18
* cvxpylayers 0.1.5
* scs 3.2.0
* hydra-core 1.0.6
* tqdm 4.60.0
* numpy 1.18.5
* python 3.6.9

## Training
If you want to train the model, you need to run the following steps sequentially.

First, you need to generate the npy file for graph construction using
```bash
$ python3 data_generate.py
```
Note that you may need to fix the file path in `data_generate.py`.

Then, you need to run the following
```
$ python3 graph_construct.py
```
to generate the graph structure file `g_structure.txt` and feature files `sequence-1_xe_fea.csv` to store node and edge features. The parameters of graph construction can be set in
`config/gm_construct.yaml`.

Next, you need to run the `train.py` to train your own model. You can set up the training parameters in `config/gm_train.yaml`.


## Prediction
You can run the prediction using
```
python predict.py data.img_dict='your npy file' data.imgs='your directory of tif files' test.save_path='your own save path'
```
or you can set up the parameters in `config/gm_test.yaml`.
